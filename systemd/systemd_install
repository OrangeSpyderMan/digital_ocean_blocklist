#!/bin/bash

# A script to install and enable the systemd timer for the DigitalOcean blocklist updater.
# This script checks for root privileges and uses sudo if necessary.

set -euo pipefail

VERBOSE=0
DEST_DIR="/usr/local/bin"

# ==========================================
# ARGUMENT PARSING
# ==========================================
while [ "$#" -gt 0 ]; do
    case "$1" in
        -v|--verbose)
            VERBOSE=1
            shift
            ;;
        -d|--destination)
            DEST_DIR="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# ==========================================
# SUDO DETECTION
# ==========================================
# If user ID is 0 (root), sudo is empty. Otherwise, sudo is "sudo".
if [ "$(id -u)" -eq 0 ]; then
    SUDO_CMD=""
else
    SUDO_CMD="sudo"
fi

# Function to print verbose messages
vprint() {
    if [ "$VERBOSE" -eq 1 ]; then
        echo "$1"
    fi
}

# Function to run a command, with optional sudo and verbosity
run_cmd() {
    local cmd=("$@")
    if [ -n "$SUDO_CMD" ]; then
        cmd=("$SUDO_CMD" "${cmd[@]}")
    fi
    vprint "Running: ${cmd[*]}"
    "${cmd[@]}"
}

# ==========================================
# INSTALLATION
# ==========================================
echo "Installing script to $DEST_DIR..."
run_cmd cp ../update_DO_blocklist "$DEST_DIR/"
run_cmd chmod +x "$DEST_DIR/update_DO_blocklist"

echo "Installing systemd units..."
run_cmd cp update_do_blocklist.service /etc/systemd/system/
# Update the ExecStart path in the service file
run_cmd sed -i "s|ExecStart=.*|ExecStart=$DEST_DIR/update_DO_blocklist -k -f \${CACHE_DIRECTORY}/do_blocklist.csv sync|" /etc/systemd/system/update_do_blocklist.service
run_cmd cp update_do_blocklist.timer /etc/systemd/system/

echo "Reloading systemd daemon..."
run_cmd systemctl daemon-reload

echo "Enabling and starting the timer..."
run_cmd systemctl enable --now update_do_blocklist.timer

echo "Installation complete."
echo
echo "Checking timer status..."
run_cmd systemctl status update_do_blocklist.timer
